{% extends "base.html" %}
{% block content %}
  <div class="stats">
    <div class="stat"><div class="stat__label">Users</div><div class="stat__value">{{ counts.users }}</div></div>
    <div class="stat"><div class="stat__label">Admins</div><div class="stat__value">{{ counts.admins }}</div></div>
    <div class="stat"><div class="stat__label">Posts</div><div class="stat__value">{{ counts.posts }}</div></div>
    <div class="stat"><div class="stat__label">Webinars</div><div class="stat__value">{{ counts.webinars }}</div></div>
    <div class="stat"><div class="stat__label">Bookings</div><div class="stat__value">{{ counts.bookings }}</div></div>
    <div class="stat"><div class="stat__label">Referrals</div><div class="stat__value">{{ counts.referrals }}</div></div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Полная очистка</h2>
      <div class="muted">Удаляет все таблицы (SQLite: DELETE, Postgres: TRUNCATE CASCADE).</div>
      <form method="post" action="/admin/data/clear-db" onsubmit="return confirm('ТОЧНО удалить ВСЕ данные?')">
        <button class="btn danger" type="submit" style="margin-top:12px">Удалить ВСЕ данные</button>
      </form>
    </div>

    <div class="card">
      <h2>Выборочное удаление</h2>
      <div class="muted">Выбери таблицы и нажми “Удалить выбранное”.</div>
      <form method="post" action="/admin/data/clear-selected" style="margin-top:12px">
        <div class="field">
          <label>Таблицы</label>
          <select name="targets" multiple size="10">
            {% for t in tables %}
              <option value="{{ t }}">{{ t }}</option>
            {% endfor %}
          </select>
        </div>
        <button class="btn danger" type="submit" onclick="return confirm('Удалить выбранные данные?')">Удалить выбранное</button>
      </form>
    </div>
  </div>

  <div class="details">
    <details class="card" open>
      <summary>Users (последние 20)</summary>
      <div class="details__body">
        <table class="table">
          <thead><tr><th>ID</th><th>Telegram</th><th>Username</th><th>Name</th><th>Blocked</th></tr></thead>
          <tbody>
            {% for u in recent_users %}
              <tr>
                <td>{{ u.id }}</td>
                <td class="muted">{{ u.telegram_id }}</td>
                <td class="muted">{% if u.username %}@{{ u.username }}{% else %}—{% endif %}</td>
                <td>{{ u.first_name or '' }} {{ u.last_name or '' }}</td>
                <td><span class="pill">{{ 'yes' if u.is_blocked else 'no' }}</span></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </details>

    <details class="card">
      <summary>Posts (последние 20)</summary>
      <div class="details__body">
        <table class="table">
          <thead><tr><th>ID</th><th>Title</th><th>Created</th></tr></thead>
          <tbody>
            {% for p in recent_posts %}
              <tr><td>{{ p.id }}</td><td><strong>{{ p.title }}</strong></td><td class="muted">{{ p.created_at }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </details>

    <details class="card">
      <summary>Webinars (последние 20)</summary>
      <div class="details__body">
        <table class="table">
          <thead><tr><th>ID</th><th>Title</th><th>Date</th><th>Status</th></tr></thead>
          <tbody>
            {% for w in recent_webinars %}
              <tr><td>{{ w.id }}</td><td><strong>{{ w.title }}</strong></td><td class="muted">{{ w.date }} {{ w.time }}</td><td><span class="pill">{{ w.status }}</span></td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </details>

    <details class="card">
      <summary>Bookings / Tickets (последние 20)</summary>
      <div class="details__body">
        <table class="table">
          <thead><tr><th>ID</th><th>User ID</th><th>Type</th><th>Status</th><th>Topic</th></tr></thead>
          <tbody>
            {% for b in recent_bookings %}
              <tr>
                <td>{{ b.id }}</td>
                <td class="muted">{{ b.user_id }}</td>
                <td><span class="pill">{{ b.type }}</span></td>
                <td class="muted">{{ b.status }}</td>
                <td class="muted">{{ b.topic or '—' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </details>

    <details class="card">
      <summary>Referrals (последние 20)</summary>
      <div class="details__body">
        <table class="table">
          <thead><tr><th>ID</th><th>Referrer</th><th>Referred</th><th>Username</th><th>Created</th></tr></thead>
          <tbody>
            {% for r in recent_referrals %}
              <tr>
                <td>{{ r.id }}</td>
                <td class="muted">{{ r.referrer_telegram_id }}</td>
                <td class="muted">{{ r.referred_telegram_id }}</td>
                <td class="muted">{% if r.referred_username %}@{{ r.referred_username }}{% else %}—{% endif %}</td>
                <td class="muted">{{ r.created_at }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </details>
  </div>
{% endblock %}

