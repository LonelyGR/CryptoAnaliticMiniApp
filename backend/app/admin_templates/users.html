{% extends "base.html" %}
{% block content %}
  <datalist id="roleOptions">
    <option value="developer"></option>
    <option value="admin"></option>
    <option value="support"></option>
    <option value="editor"></option>
    <option value="разработчик"></option>
    <option value="админ"></option>
    <option value="поддержка"></option>
    <option value="редактор"></option>
  </datalist>

  <div class="admin-users-v2">
    <div class="admin-users-v2__panel">
      <h2 class="admin-users-v2__title">Пользователи панели</h2>

      <div class="admin-users-v2__search">
        <input id="userSearch" placeholder="Search" />
      </div>

      <div class="admin-users-v2__list" id="userList">
        {% for u in users %}
          <a
            class="user-mini {% if selected_user and selected_user.id == u.id %}is-active{% endif %}"
            href="/admin/users?u={{ u.id }}"
            data-search="{{ (u.username ~ ' ' ~ u.role ~ ' ' ~ (u.scopes or '')) | lower }}"
          >
            <div class="user-mini__left">
              <div class="user-mini__avatar">{{ (u.username[:1] if u.username else 'U')|upper }}</div>
              <div style="min-width:0">
                <div class="user-mini__name">{{ u.username }}</div>
                <div class="user-mini__meta">{{ u.role }} · {{ 'active' if u.is_active else 'inactive' }}</div>
              </div>
            </div>
            <div class="user-mini__right">
              <span class="pill">#{{ u.id }}</span>
            </div>
          </a>
        {% endfor %}

        {% if not users %}
          <div class="muted">Пользователей пока нет.</div>
        {% endif %}
      </div>

      <div class="card" style="margin-top: 14px">
        <h2 class="admin-users-v2__title">Создать пользователя</h2>
        <form method="post" action="/admin/users/create">
          <div class="field">
            <label>Логин</label>
            <input name="username" required />
          </div>
          <div class="field">
            <label>Пароль</label>
            <input name="password" type="password" required />
          </div>
          <div class="field">
            <label>Роль</label>
            <input name="role" value="admin" list="roleOptions" />
          </div>
          <div class="perm-actions">
            <label class="btn"><input type="checkbox" name="perms" value="*" /> полный доступ (*)</label>
            <button class="btn primary" type="submit">Создать</button>
          </div>
        </form>
      </div>
    </div>

    <div class="admin-users-v2__panel">
      {% if selected_user %}
        <div class="admin-users-v2__detailHeader">
          <div>
            <h2 class="admin-users-v2__detailTitle">{{ selected_user.username }}</h2>
            <div class="admin-users-v2__detailSub">Роль: <strong>{{ selected_user.role }}</strong> · ID: <strong>#{{ selected_user.id }}</strong></div>
          </div>
          <span class="pill">{{ 'active' if selected_user.is_active else 'inactive' }}</span>
        </div>

        <form method="post" action="/admin/users/{{ selected_user.id }}/update">
          <div class="row" style="align-items:flex-end">
            <div class="field" style="flex:1">
              <label>Роль</label>
              <input name="role" value="{{ selected_user.role }}" list="roleOptions" />
            </div>
            <div class="field" style="flex:2">
              <label>Scopes (опционально)</label>
              <input name="scopes" value="{{ selected_user.scopes or '' }}" placeholder="posts:view,posts:write или *" />
            </div>
          </div>

          <div class="perm-actions">
            <label class="btn"><input type="checkbox" name="perms" value="*" {% if '*' in user_scopes[selected_user.id] %}checked{% endif %} /> полный доступ (*)</label>
            <label class="toggle"><input type="checkbox" name="is_active" value="1" {% if selected_user.is_active %}checked{% endif %} /> <strong>active</strong></label>
            <button class="btn" type="submit">Сохранить</button>
          </div>

          <div class="perm-grid-v2">
            {% for group, scope, title, desc in perms %}
              <div class="perm-tile">
                <div class="perm-tile__top">
                  <div style="min-width:0">
                    <div class="perm-tile__title">{{ title }}</div>
                    <div class="perm-tile__desc">{{ group }} · {{ desc }}</div>
                  </div>
                  <label class="switch">
                    <input
                      type="checkbox"
                      name="perms"
                      value="{{ scope }}"
                      {% if (scope in user_scopes[selected_user.id]) or (scope.split(':')[0] in user_scopes[selected_user.id]) or ('*' in user_scopes[selected_user.id]) %}checked{% endif %}
                    />
                  </label>
                </div>
              </div>
            {% endfor %}
          </div>
        </form>

        <div class="user-actions" style="margin-top:14px">
          <form method="post" action="/admin/users/{{ selected_user.id }}/reset-password" class="user-reset" onsubmit="return confirm('Сбросить пароль пользователю {{ selected_user.username }}?')">
            <input name="new_password" type="password" placeholder="Новый пароль" required />
            <button class="btn ok" type="submit">Сохранить</button>
          </form>
          <form method="post" action="/admin/users/{{ selected_user.id }}/delete" onsubmit="return confirm('Удалить пользователя {{ selected_user.username }}?')">
            <button class="btn danger" type="submit">Удалить</button>
          </form>
        </div>
      {% else %}
        <div class="muted">Пользователей пока нет.</div>
      {% endif %}
    </div>
  </div>

  <script>
    (function () {
      var input = document.getElementById('userSearch');
      if (!input) return;
      input.addEventListener('input', function () {
        var q = (input.value || '').trim().toLowerCase();
        var items = document.querySelectorAll('#userList [data-search]');
        items.forEach(function (el) {
          var hay = (el.getAttribute('data-search') || '');
          var ok = !q || hay.indexOf(q) !== -1;
          el.style.display = ok ? '' : 'none';
        });
      });
    })();
  </script>
{% endblock %}

