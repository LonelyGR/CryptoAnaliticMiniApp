{
  email {$ACME_EMAIL}

  # --- Global server hardening (timeouts etc.) ---
  servers {
    timeouts {
      read_header 10s
      read_body 30s
      write 60s
      idle 5m
    }
  }
}

{$DOMAIN} {
  encode zstd gzip

  # --- Logging (needed for incident response, anti-bot tooling, audits) ---
  log {
    output file /var/log/caddy/access.log {
      roll_size 20MiB
      roll_keep 10
      roll_keep_for 240h
    }
    format json
    level INFO
  }

  # --- Global "clean response" baseline ---
  header {
    # Remove both Caddy and upstream "Server" headers (avoid double "Server:" in responses)
    -Server

    # General security headers (safe defaults)
    X-Content-Type-Options "nosniff"
    Referrer-Policy "strict-origin-when-cross-origin"
    Permissions-Policy "camera=(), microphone=(), geolocation=()"
    X-Permitted-Cross-Domain-Policies "none"
    X-DNS-Prefetch-Control "off"

    # Enable only if HTTPS is stable for this domain.
    Strict-Transport-Security "max-age=15552000; includeSubDomains; preload"
  }

  # --- Anti-scan / reduce noise ---
  @blocked_paths {
    path /wp-admin* /wp-login.php /xmlrpc.php /cgi-bin* /phpmyadmin* /pma* /admin.php /server-status /actuator* /.git* /.env* /vendor/phpunit* /HNAP1 /boaform/admin/formLogin
  }
  respond @blocked_paths 404

  # Block dangerous methods
  @blocked_methods method TRACE TRACK
  respond @blocked_methods 405

  # Reasonable global request body limit (route-specific limits below can be tighter)
  request_body {
    max_size 5MB
  }

  # API -> backend (internal only)
  handle_path /api/* {
    request_body {
      max_size 2MB
    }
    header {
      # Don't inherit front-end CSP for API responses; keep them simple.
      -Content-Security-Policy
      Cache-Control "no-store"
      X-Robots-Tag "noindex, nofollow"
    }
    reverse_proxy backend:8000 {
      header_down -Server
    }
  }

  # Backend Admin Panel (must NOT be handled by frontend SPA)
  # IMPORTANT: use "handle" (not handle_path) so /admin prefix is preserved
  handle /admin* {
    request_body {
      max_size 5MB
    }
    header {
      # Admin should not be embeddable anywhere
      Content-Security-Policy "default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'none'; form-action 'self'"
      X-Frame-Options "DENY"
      Cache-Control "no-store"
      X-Robots-Tag "noindex, nofollow"
    }
    reverse_proxy backend:8000 {
      header_down -Server
    }
  }

  # Everything else -> frontend (nginx static)
  handle {
    # Telegram Mini App frontend: allow embedding inside Telegram Web (avoid X-Frame-Options:DENY).
    header {
      Content-Security-Policy "default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'self' https://web.telegram.org https://*.telegram.org https://t.me; script-src 'self' https://telegram.org; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https://assets.coingecko.com https://t.me https://*.telegram.org https://*.telesco.pe; connect-src 'self' https://api.binance.com; upgrade-insecure-requests"
    }
    reverse_proxy frontend:80 {
      header_down -Server
    }
  }
}

